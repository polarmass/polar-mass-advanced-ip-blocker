jQuery(document).ready(function(a){if(a('.pmip-register-cron input[type="submit"]').on("click",function(e){if(e.preventDefault(),confirm(pmipAdmin.i18n.confirmCron)){let i=a(this);i.prop("disabled",!0),a.post(pmipAdmin.ajaxUrl,{action:"pmip_register_cron",nonce:pmipAdmin.nonce}).done(e=>{alert(e.data.message||pmipAdmin.i18n.error),e.success?a(".pmip-register-cron").fadeTo(300,0).slideUp(300,function(){a(this).remove()}):i.prop("disabled",!1)}).fail(()=>{alert(pmipAdmin.i18n.error),i.prop("disabled",!1)})}}),a(".pmip-show-token-instructions").on("click",function(e){e.preventDefault(),a("#pmip-token-instructions").fadeIn(300),a("body").addClass("pmip-modal-open")}),a("#pmip-close").on("click",function(){a("#pmip-token-instructions").fadeOut(300),a("body").removeClass("pmip-modal-open")}),a("#pmip-token-instructions").on("click",function(e){a(e.target).is("#pmip-token-instructions")&&(a("#pmip-token-instructions").fadeOut(300),a("body").removeClass("pmip-modal-open"))}),a("#pmip-block-ip").on("click",function(){var e=a("#pmip-ip-input").val().trim();e?confirm(pmipAdmin.i18n.confirmBlock)&&a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_block_ip",nonce:pmipAdmin.nonce,ip:e},beforeSend:function(){a("#pmip-block-ip").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),a("#pmip-ip-input").val(""),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){a("#pmip-block-ip").prop("disabled",!1)}}):alert(pmipAdmin.i18n.enterIp)}),a("#pmip-unblock-ip").on("click",function(){var e=a("#pmip-ip-input").val().trim();e?confirm(pmipAdmin.i18n.confirmUnblock)&&a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_unblock_ip",nonce:pmipAdmin.nonce,ip:e},beforeSend:function(){a("#pmip-unblock-ip").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),a("#pmip-ip-input").val(""),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){a("#pmip-unblock-ip").prop("disabled",!1)}}):alert(pmipAdmin.i18n.enterIp)}),a("#pmip-log-level").on("change",function(){let e=a(this).val();(e?(a(".pmip-log-entries tr").hide(),a(".pmip-log-entries tr:first").show(),a(".pmip-log-entries tr").filter(function(){return a(this).find("td:eq(1)").text().toLowerCase()===e})):a(".pmip-log-entries tr")).show()}),a("#pmip-export-logs").on("click",function(){window.location.href=pmipAdmin.ajaxUrl+"?action=pmip_export_logs&nonce="+pmipAdmin.nonce}),a("#pmip-ip-input").on("input",function(){var e=a(this).val().trim();!e||/^(\d{1,3}\.){3}\d{1,3}$/.test(e)||/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(e)?a(this).removeClass("error"):a(this).addClass("error")}),a("#pmip-sync-wordfence").on("click",function(){confirm(pmipAdmin.i18n.confirmSync)&&a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_sync_wordfence",nonce:pmipAdmin.nonce},beforeSend:function(){a("#pmip-sync-wordfence").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){a("#pmip-sync-wordfence").prop("disabled",!1)}})}),a("#pmip-toggle-token-visibility").on("click",function(){var e=a("#pmip_master_token"),i=a(this).find(".dashicons");"password"===e.attr("type")?(e.attr("type","text"),i.removeClass("dashicons-visibility").addClass("dashicons-hidden")):(e.attr("type","password"),i.removeClass("dashicons-hidden").addClass("dashicons-visibility"))}),a("#pmip-view-details-toggle").on("click",function(e){e.preventDefault();var e=a("#pmip-connection-details"),i=a(this);e.is(":visible")?(e.slideUp(),i.text(i.data("show-text")||"View Details")):(e.slideDown(),i.text(i.data("hide-text")||"Hide Details"))}),a("#pmip-advanced-config-toggle").on("click",function(e){e.preventDefault();var e=a(".pmip-manual-config-section"),i=a("#pmip-manual-config");a(this);i.is(":visible")?(i.slideUp(),e.removeClass("open")):(i.slideDown(),e.addClass("open"))}),a("#pmip_zone_select").on("change",function(){var e=a("#pmip-select-zone-btn");a(this).val()?e.prop("disabled",!1):e.prop("disabled",!0)}),a("#pmip-test-connection").on("click",function(){let e=a(this),i=e.text();e.prop("disabled",!0).text("Testing..."),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_test_connection",nonce:pmipAdmin.nonce},success:function(e){e.success?(alert(e.data.message||"Connection test successful!"),location.reload()):alert(e.data.message||"Connection test failed. Please check your configuration.")},error:function(){alert("Error testing connection. Please try again.")},complete:function(){e.prop("disabled",!1).text(i)}})}),a("#pmip-reconnect-btn").on("click",function(){var e=a(".pmip-setup-flow");e.length&&e.is(":visible")?a("html, body").animate({scrollTop:e.offset().top-50},500):(a("#pmip-advanced-config-toggle").trigger("click"),setTimeout(function(){a("html, body").animate({scrollTop:a(".pmip-cloudflare-setup-card").offset().top-50},500)},300))}),a("#pmip-reset-cloudflare").on("click",function(){if(confirm("Are you sure you want to reset all Cloudflare connection settings? This will clear your API token, zone ID, ruleset ID, and rule ID. You will need to reconnect.")){let i=a(this),t=i.text();i.prop("disabled",!0).text("Resetting..."),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_reset_cloudflare",nonce:pmipAdmin.nonce},success:function(e){e.success?(alert(e.data.message||"Settings reset successfully!"),location.reload()):(alert(e.data.message||"Failed to reset settings. Please try again."),i.prop("disabled",!1).text(t))},error:function(){alert("Error resetting settings. Please try again."),i.prop("disabled",!1).text(t)}})}}),a("#pmip-auto-connect-btn").on("click",function(){var e=a("#pmip_master_token").val().trim();let i=a(this),t=a("#pmip-auto-connect-status"),n=a("#pmip-auto-connect-message");var s=a("#pmip-zone-selection");let o=a("#pmip_zone_select");e?(i.prop("disabled",!0),t.html('<span class="spinner is-active" style="float: none; margin: 0;"></span> Connecting...'),n.html(""),s.hide(),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_auto_connect",nonce:pmipAdmin.nonce,master_token:e},success:function(e){e.success?(t.html('<span style="color: green;">✓ Connected!</span>'),n.html('<div class="notice notice-success inline"><p><strong>Success!</strong> '+e.data.message+"</p></div>"),e.data.zones&&0<e.data.zones.length&&(o.empty().append('<option value="">-- Please select a zone --</option>'),e.data.zones.forEach(function(e){o.append('<option value="'+e.id+'">'+e.name+" ("+e.id+")</option>")}),a("#pmip-step-2").slideDown(),a("#pmip-select-zone-btn").prop("disabled",!0))):(t.html(""),n.html('<div class="notice notice-error inline"><p><strong>Error:</strong> '+(e.data.message||pmipAdmin.i18n.error)+"</p></div>"),i.prop("disabled",!1))},error:function(){t.html(""),n.html('<div class="notice notice-error"><p><strong>Error:</strong> '+pmipAdmin.i18n.error+"</p></div>"),i.prop("disabled",!1)}})):n.html('<div class="notice notice-error"><p>Please enter your master token.</p></div>')}),a("#pmip-select-zone-btn").on("click",function(){var e=a("#pmip_zone_select").val();let i=a(this),t=a("#pmip-zone-selection-status"),n=a("#pmip-zone-selection-message"),s=a("#pmip_zone_select");e?(i.prop("disabled",!0),s.prop("disabled",!0),t.html('<span class="spinner is-active" style="float: none; margin: 0;"></span> Creating rule...'),n.html(""),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_select_zone",nonce:pmipAdmin.nonce,zone_id:e},success:function(e){e.success?(t.html('<span style="color: green;">✓ Rule Created!</span>'),n.html('<div class="notice notice-success inline"><p><strong>Success!</strong> '+e.data.message+"</p></div>"),setTimeout(function(){location.reload()},2e3)):(t.html(""),n.html('<div class="notice notice-error inline"><p><strong>Error:</strong> '+(e.data.message||pmipAdmin.i18n.error)+"</p></div>"),i.prop("disabled",!1),s.prop("disabled",!1))},error:function(){t.html(""),n.html('<div class="notice notice-error inline"><p><strong>Error:</strong> '+pmipAdmin.i18n.error+"</p></div>"),i.prop("disabled",!1),s.prop("disabled",!1)}})):n.html('<div class="notice notice-error"><p>Please select a zone.</p></div>')}),pmipAdmin.isSubscribed)a(".pmip-newsletter-form").hide(),a(".pmip-newsletter").append('<div class="pmip-newsletter-success"><p>You are already subscribed!</p></div>');else{a(".pmip-newsletter-form").on("submit",function(e){e.preventDefault();e=a(this).find('input[type="email"]').val();let i=a(".pmip-newsletter-message"),t=a(this).find("button"),n=a(this);a(".pmip-newsletter");a.ajax({url:"https://polarmass.com/wp-json/pmip/v1/newsletter/signup",type:"POST",contentType:"application/json",data:JSON.stringify({email:e}),beforeSend:function(){t.prop("disabled",!0),n.css("opacity","0.5")},success:function(e){e.success?(n.fadeOut(300,function(){var e=a('<div class="pmip-newsletter-success"><p>Thank you for subscribing to our newsletter!</p></div>').hide();a(this).after(e),e.fadeIn(300)}),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_update_newsletter_status",nonce:pmipAdmin.nonce}})):i.removeClass("success").addClass("error").text(e.data.message).fadeIn()},error:function(){i.removeClass("success").addClass("error").text(pmipAdmin.i18n.error).fadeIn()},complete:function(){t.prop("disabled",!1),n.css("opacity","1"),setTimeout(function(){i.fadeOut()},5e3)}})});let i=document.querySelectorAll(".pmip-tabs .pmip-tab"),t=document.querySelectorAll(".pmip-tab-content"),n=(i.forEach(e=>{e.addEventListener("click",function(){i.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),this.classList.add("active");var e=document.querySelector(".pmip-tab-content-"+this.dataset.tab);e&&e.classList.add("active")})}),document.createElement("div")),e=(n.className="pmip-lightbox-overlay",n.innerHTML='<span class="pmip-lightbox-close">&times;</span><img src="" alt="Preview">',document.body.appendChild(n),document.querySelectorAll(".pmip-lightbox").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),n.querySelector("img").src=this.href,n.classList.add("active")})}),n.querySelector(".pmip-lightbox-close")&&(n.querySelector(".pmip-lightbox-close").onclick=function(){n.classList.remove("active"),n.querySelector("img").src=""}),n.onclick=function(e){e.target===n&&(n.classList.remove("active"),n.querySelector("img").src="")},a("#pmip_use_ip_list")),s=a("#pmip-ip-list-info"),o=a("#pmip-lists-info");var r=a("#pmip-refresh-lists");let p=a("#pmip-create-list");function c(){e.is(":checked")?(s.show(),l()):s.hide()}function l(){o.html('<p class="description"><span class="spinner is-active" style="float: none; margin: 0 10px 0 0;"></span>Loading IP lists information...</p>'),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_get_ip_lists",nonce:pmipAdmin.nonce},success:function(n){if(n.success&&n.data){var s=n.data;let e="",i=s.total_lists||0,t=s.plugin_list;e+='<p class="description"><strong>Total IP Lists:</strong> '+i+"</p>",t?(e=(e=(e=(e+='<div style="margin-top: 10px; padding: 10px; background: #f0f6fc; border-left: 4px solid #2271b1; border-radius: 4px;">')+"<p><strong>Plugin IP List Found:</strong> "+t.name+"</p>")+"<p><strong>Items:</strong> "+(t.num_items||0)+"</p>")+"<p><strong>Referenced by:</strong> "+(t.num_referencing_filters||0)+" filter(s)</p>",t.description&&(e+="<p><strong>Description:</strong> "+t.description+"</p>"),e+="</div>",p.hide()):(e=(e+='<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffb900; border-radius: 4px;">')+'<p><strong>No IP list found for this plugin.</strong> Click "Create IP List" to create one.</p></div>',p.show()),o.html(e)}else o.html('<p class="description" style="color: #d63638;">'+(n.data?.message||"Failed to load IP lists")+"</p>")},error:function(){o.html('<p class="description" style="color: #d63638;">Error loading IP lists. Please try again.</p>')}})}e.on("change",function(){c()}),e.is(":checked")&&c(),r.on("click",function(){l()}),p.on("click",function(){let i=a(this);i.prop("disabled",!0).text("Creating..."),a.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_create_ip_list",nonce:pmipAdmin.nonce},success:function(e){e.success?(alert(e.data.message||"IP list created successfully!"),l()):(alert(e.data?.message||"Failed to create IP list. Please try again."),i.prop("disabled",!1).text("Create IP List"))},error:function(){alert("Error creating IP list. Please try again."),i.prop("disabled",!1).text("Create IP List")}})})}});