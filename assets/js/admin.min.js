jQuery(document).ready(function(s){if(s('.pmip-register-cron input[type="submit"]').on("click",function(e){if(e.preventDefault(),confirm(pmipAdmin.i18n.confirmCron)){let i=s(this);i.prop("disabled",!0),s.post(pmipAdmin.ajaxUrl,{action:"pmip_register_cron",nonce:pmipAdmin.nonce}).done(e=>{alert(e.data.message||pmipAdmin.i18n.error),e.success?s(".pmip-register-cron").fadeTo(300,0).slideUp(300,function(){s(this).remove()}):i.prop("disabled",!1)}).fail(()=>{alert(pmipAdmin.i18n.error),i.prop("disabled",!1)})}}),s(".pmip-show-token-instructions").on("click",function(e){e.preventDefault(),s("#pmip-token-instructions").fadeIn(300),s("body").addClass("pmip-modal-open")}),s("#pmip-close").on("click",function(){s("#pmip-token-instructions").fadeOut(300),s("body").removeClass("pmip-modal-open")}),s("#pmip-token-instructions").on("click",function(e){s(e.target).is("#pmip-token-instructions")&&(s("#pmip-token-instructions").fadeOut(300),s("body").removeClass("pmip-modal-open"))}),s("#pmip-block-ip").on("click",function(){var e=s("#pmip-ip-input").val().trim();e?confirm(pmipAdmin.i18n.confirmBlock)&&s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_block_ip",nonce:pmipAdmin.nonce,ip:e},beforeSend:function(){s("#pmip-block-ip").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),s("#pmip-ip-input").val(""),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){s("#pmip-block-ip").prop("disabled",!1)}}):alert(pmipAdmin.i18n.enterIp)}),s("#pmip-unblock-ip").on("click",function(){var e=s("#pmip-ip-input").val().trim();e?confirm(pmipAdmin.i18n.confirmUnblock)&&s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_unblock_ip",nonce:pmipAdmin.nonce,ip:e},beforeSend:function(){s("#pmip-unblock-ip").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),s("#pmip-ip-input").val(""),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){s("#pmip-unblock-ip").prop("disabled",!1)}}):alert(pmipAdmin.i18n.enterIp)}),s("#pmip-log-level").on("change",function(){let e=s(this).val();(e?(s(".pmip-log-entries tr").hide(),s(".pmip-log-entries tr:first").show(),s(".pmip-log-entries tr").filter(function(){return s(this).find("td:eq(1)").text().toLowerCase()===e})):s(".pmip-log-entries tr")).show()}),s("#pmip-export-logs").on("click",function(){window.location.href=pmipAdmin.ajaxUrl+"?action=pmip_export_logs&nonce="+pmipAdmin.nonce}),s("#pmip-ip-input").on("input",function(){var e=s(this).val().trim();!e||/^(\d{1,3}\.){3}\d{1,3}$/.test(e)||/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(e)?s(this).removeClass("error"):s(this).addClass("error")}),s("#pmip-sync-wordfence").on("click",function(){confirm(pmipAdmin.i18n.confirmSync)&&s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_sync_wordfence",nonce:pmipAdmin.nonce},beforeSend:function(){s("#pmip-sync-wordfence").prop("disabled",!0)},success:function(e){e.success?(alert(e.data.message),location.reload()):alert(e.data.message||pmipAdmin.i18n.error)},error:function(){alert(pmipAdmin.i18n.error)},complete:function(){s("#pmip-sync-wordfence").prop("disabled",!1)}})}),s(".pmip-tab-header").on("click",function(){var e=s(this).data("tab");s(".pmip-tab-header").removeClass("active").css({"border-bottom-color":"transparent",color:"#646970"}),s(this).addClass("active").css({"border-bottom-color":"#2271b1",color:"#2271b1"}),s(".pmip-tab-content").hide(),s("#pmip-tab-"+e).show()}),s("#pmip-auto-connect-btn").on("click",function(){var e=s("#pmip_master_token").val().trim();let i=s(this),n=s("#pmip-auto-connect-status"),t=s("#pmip-auto-connect-message"),o=s("#pmip-zone-selection"),p=s("#pmip_zone_select");e?(i.prop("disabled",!0),n.html('<span class="spinner is-active" style="float: none; margin: 0;"></span> Connecting...'),t.html(""),o.hide(),s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_auto_connect",nonce:pmipAdmin.nonce,master_token:e},success:function(e){e.success?(n.html('<span style="color: green;">✓ Connected!</span>'),t.html('<div class="notice notice-success"><p><strong>Success!</strong> '+e.data.message+"</p></div>"),e.data.zones&&0<e.data.zones.length&&(p.empty().append('<option value="">-- Please select a zone --</option>'),e.data.zones.forEach(function(e){p.append('<option value="'+e.id+'">'+e.name+" ("+e.id+")</option>")}),o.show())):(n.html(""),t.html('<div class="notice notice-error"><p><strong>Error:</strong> '+(e.data.message||pmipAdmin.i18n.error)+"</p></div>"),i.prop("disabled",!1))},error:function(){n.html(""),t.html('<div class="notice notice-error"><p><strong>Error:</strong> '+pmipAdmin.i18n.error+"</p></div>"),i.prop("disabled",!1)}})):t.html('<div class="notice notice-error"><p>Please enter your master token.</p></div>')}),s("#pmip-select-zone-btn").on("click",function(){var e=s("#pmip_zone_select").val();let i=s(this),n=s("#pmip-zone-selection-status"),t=s("#pmip-zone-selection-message");e?(i.prop("disabled",!0),n.html('<span class="spinner is-active" style="float: none; margin: 0;"></span> Creating rule...'),t.html(""),s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_select_zone",nonce:pmipAdmin.nonce,zone_id:e},success:function(e){e.success?(n.html('<span style="color: green;">✓ Rule Created!</span>'),t.html('<div class="notice notice-success"><p><strong>Success!</strong> '+e.data.message+"</p></div>"),setTimeout(function(){location.reload()},2e3)):(n.html(""),t.html('<div class="notice notice-error"><p><strong>Error:</strong> '+(e.data.message||pmipAdmin.i18n.error)+"</p></div>"),i.prop("disabled",!1))},error:function(){n.html(""),t.html('<div class="notice notice-error"><p><strong>Error:</strong> '+pmipAdmin.i18n.error+"</p></div>"),i.prop("disabled",!1)}})):t.html('<div class="notice notice-error"><p>Please select a zone.</p></div>')}),pmipAdmin.isSubscribed)s(".pmip-newsletter-form").hide(),s(".pmip-newsletter").append('<div class="pmip-newsletter-success"><p>You are already subscribed!</p></div>');else{s(".pmip-newsletter-form").on("submit",function(e){e.preventDefault();e=s(this).find('input[type="email"]').val();let i=s(".pmip-newsletter-message"),n=s(this).find("button"),t=s(this);s(".pmip-newsletter");s.ajax({url:"https://polarmass.com/wp-json/pmip/v1/newsletter/signup",type:"POST",contentType:"application/json",data:JSON.stringify({email:e}),beforeSend:function(){n.prop("disabled",!0),t.css("opacity","0.5")},success:function(e){e.success?(t.fadeOut(300,function(){var e=s('<div class="pmip-newsletter-success"><p>Thank you for subscribing to our newsletter!</p></div>').hide();s(this).after(e),e.fadeIn(300)}),s.ajax({url:pmipAdmin.ajaxUrl,type:"POST",data:{action:"pmip_update_newsletter_status",nonce:pmipAdmin.nonce}})):i.removeClass("success").addClass("error").text(e.data.message).fadeIn()},error:function(){i.removeClass("success").addClass("error").text(pmipAdmin.i18n.error).fadeIn()},complete:function(){n.prop("disabled",!1),t.css("opacity","1"),setTimeout(function(){i.fadeOut()},5e3)}})});let i=document.querySelectorAll(".pmip-tabs .pmip-tab"),n=document.querySelectorAll(".pmip-tab-content"),t=(i.forEach(e=>{e.addEventListener("click",function(){i.forEach(e=>e.classList.remove("active")),n.forEach(e=>e.classList.remove("active")),this.classList.add("active");var e=document.querySelector(".pmip-tab-content-"+this.dataset.tab);e&&e.classList.add("active")})}),document.createElement("div"));t.className="pmip-lightbox-overlay",t.innerHTML='<span class="pmip-lightbox-close">&times;</span><img src="" alt="Preview">',document.body.appendChild(t),document.querySelectorAll(".pmip-lightbox").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),t.querySelector("img").src=this.href,t.classList.add("active")})}),t.querySelector(".pmip-lightbox-close")&&(t.querySelector(".pmip-lightbox-close").onclick=function(){t.classList.remove("active"),t.querySelector("img").src=""}),t.onclick=function(e){e.target===t&&(t.classList.remove("active"),t.querySelector("img").src="")}}});